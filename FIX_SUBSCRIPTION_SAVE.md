# Fix Subscription Save - Plan Now Saves to Database

## ‚úÖ –°—Ç–∞—Ç—É—Å: –ü–æ–¥–ø–∏—Å–∫–∞ —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

**–î–∞—Ç–∞:** 15 –¥–µ–∫–∞–±—Ä—è 2024

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–ª–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–ª –ø–ª–∞–Ω
- –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ localStorage
- –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å
- QR —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ

---

## üîç –ü—Ä–∏—á–∏–Ω–∞

–í `SubscriptionsPremium.js` –Ω–µ –±—ã–ª–æ API –≤—ã–∑–æ–≤–∞ –∫ backend:

```javascript
// –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
const handlePurchase = async (planId) => {
  // –¢–æ–ª—å–∫–æ —Å–∏–º—É–ª—è—Ü–∏—è –æ–ø–ª–∞—Ç—ã
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ
  const subscription = {
    id: 'sub_' + Date.now(),  // ‚ùå –õ–æ–∫–∞–ª—å–Ω—ã–π ID
    plan_id: planId,
    status: 'active'
  };
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ localStorage
  localStorage.setItem('active_subscription', JSON.stringify(subscription));
  
  // ‚ùå –ù–ï–¢ –∑–∞–ø—Ä–æ—Å–∞ –∫ backend!
};
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω API –≤—ã–∑–æ–≤ –∫ backend

```javascript
// –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
const handlePurchase = async (planId) => {
  // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
  const token = localStorage.getItem('token');
  
  // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ backend
  const response = await axios.post(
    `${API_URL}/api/subscription/subscriptions`,
    {
      plan_id: planId,
      auto_renew: true
    },
    {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    }
  );

  // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –∏–∑ –æ—Ç–≤–µ—Ç–∞ backend
  const subscription = {
    id: response.data.id,              // ‚úÖ –†–µ–∞–ª—å–Ω—ã–π ID –∏–∑ –ë–î
    plan_id: response.data.plan_id,
    status: response.data.status,      // ‚úÖ 'active'
    visits_remaining: response.data.visits_remaining,  // ‚úÖ –ò–∑ –ø–ª–∞–Ω–∞
    is_unlimited: response.data.is_unlimited,
    start_date: response.data.start_date,
    end_date: response.data.end_date
  };
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è UI
  localStorage.setItem('active_subscription', JSON.stringify(subscription));
};
```

### –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

1. **API –≤—ã–∑–æ–≤** - –∑–∞–ø—Ä–æ—Å –∫ `/api/subscription/subscriptions`
2. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è Bearer token
3. **–†–µ–∞–ª—å–Ω—ã–π ID** - ID –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
4. **visits_remaining** - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏–∑ –ø–ª–∞–Ω–∞
5. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

```bash
docker-compose restart user_app
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úî Container yuvgo_user_app  Started
```

---

## üìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É

```
http://localhost:3003/login
```

**–î–∞–Ω–Ω—ã–µ:**
- –¢–µ–ª–µ—Ñ–æ–Ω: +998901234567
- –ü–∞—Ä–æ–ª—å: password123

### 2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ü–æ–¥–ø–∏—Å–∫–∏

```
http://localhost:3003/subscriptions
```

### 3. –í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω

–ù–∞–∂–º–∏—Ç–µ "–í—ã–±—Ä–∞—Ç—å –ø–ª–∞–Ω" –Ω–∞ –ª—é–±–æ–º –ø–ª–∞–Ω–µ:
- –ë–∞–∑–æ–≤—ã–π (10 –≤–∏–∑–∏—Ç–æ–≤)
- –°—Ç–∞–Ω–¥–∞—Ä—Ç (20 –≤–∏–∑–∏—Ç–æ–≤)
- –ü—Ä–µ–º–∏—É–º (–±–µ–∑–ª–∏–º–∏—Ç)

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–î–æ–ª–∂–Ω–æ –ø—Ä–æ–∏–∑–æ–π—Ç–∏:**
1. ‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ backend
2. ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ –ë–î
3. ‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω —Å —Ä–µ–∞–ª—å–Ω—ã–º ID
4. ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ localStorage
5. ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
6. ‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

**–ù–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:**
```
–ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
–û—Å—Ç–∞–ª–æ—Å—å –≤–∏–∑–∏—Ç–æ–≤: 10
```

### 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ QR —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

```
http://localhost:3003/qr
```

**–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥:**
```
MERCHANT_452f6116-fb1e-43ce-b9b8-1060cfdaa6b3_1765803131
```

**–î–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å–ø–µ—Ö:**
```
‚úÖ Check-in successful
Visits remaining: 9
```

---

## üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –ë–î

```bash
docker exec -it yuvgo_postgres psql -U yuvgo_user -d yuvgo_db
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É

```sql
SELECT 
    s.id,
    u.phone_number,
    s.plan_id,
    s.status,
    s.visits_remaining,
    s.start_date,
    s.end_date
FROM subscriptions s
JOIN users u ON s.user_id = u.id
WHERE u.phone_number = '+998901234567'
ORDER BY s.created_at DESC
LIMIT 1;
```

**–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:**
```
id                  | 123e4567-e89b-12d3-a456-426614174000
phone_number        | +998901234567
plan_id            | basic-plan
status             | active
visits_remaining   | 10
start_date         | 2024-12-15 12:00:00
end_date           | 2025-01-15 12:00:00
```

---

## üìä API Flow

### –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å

```
1. Frontend: POST /api/subscription/subscriptions
   Headers: Authorization: Bearer <token>
   Body: { plan_id: "basic-plan", auto_renew: true }

2. Backend: subscription/main.py
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω
   - –ü–æ–ª—É—á–∞–µ—Ç user_id
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–ª–∞–Ω
   - –°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –≤ –ë–î
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

3. Response:
   {
     "id": "123e4567-...",
     "user_id": "...",
     "plan_id": "basic-plan",
     "status": "active",
     "visits_remaining": 10,
     "is_unlimited": false,
     "start_date": "2024-12-15T...",
     "end_date": "2025-01-15T..."
   }

4. Frontend:
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ localStorage
   - –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /home
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ–¥–ø–∏—Å–∫–∏
```

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. ‚úÖ –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ backend
2. ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ –†–µ–∞–ª—å–Ω—ã–π ID –∏–∑ –ë–î
4. ‚úÖ visits_remaining —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
5. ‚úÖ QR —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
6. ‚úÖ –í–∏–∑–∏—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –∏ —É–º–µ–Ω—å—à–∞—é—Ç —Å—á–µ—Ç—á–∏–∫

**–ü–æ–ª–Ω—ã–π flow:**
```
–í—Ö–æ–¥ ‚Üí –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ ‚Üí API –∑–∞–ø—Ä–æ—Å ‚Üí –ë–î ‚Üí localStorage ‚Üí QR —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

**–û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Console**

–ü—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–ª–∞–Ω–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏:
```
POST http://localhost:8002/api/subscription/subscriptions
Status: 200 OK
Response: { id: "...", status: "active", ... }
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞

```javascript
console.log(localStorage.getItem('token'));
```

–î–æ–ª–∂–µ–Ω –±—ã—Ç—å JWT —Ç–æ–∫–µ–Ω

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏

```javascript
console.log(JSON.parse(localStorage.getItem('active_subscription')));
```

–î–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º ID –∏–∑ –ë–î

---

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏

### "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –≤ localStorage

**–†–µ—à–µ–Ω–∏–µ:**
1. –í—ã–π–¥–∏—Ç–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
2. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –ø–ª–∞–Ω

### "User already has active subscription"

**–ü—Ä–∏—á–∏–Ω–∞:** –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
2. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, —É–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ SQL
3. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### Network Error

**–ü—Ä–∏—á–∏–Ω–∞:** Backend –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
```bash
docker-compose ps subscription_service
docker-compose logs subscription_service
```

---

**–ì–æ—Ç–æ–≤–æ! ‚úÖ**

**–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–ª–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ QR —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!**

---

**–ê–≤—Ç–æ—Ä:** Cascade AI  
**–î–∞—Ç–∞:** 15 –¥–µ–∫–∞–±—Ä—è 2024
